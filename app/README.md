# 🌊 Self-Hosted Live Stream Relay

A complete self-hosted HLS stream relay system using FFmpeg that automatically pulls daily streams from your configured source and serves them via a modern web interface. Perfect for cloud deployment with automatic restarts and monitoring.

## ✨ Features

- 🔄 **Automatic Daily Stream Updates**: Constructs source URLs based on current date and your configured stream source
- 🎥 **HLS Streaming**: FFmpeg-powered HLS segmentation and delivery  
- 📱 **Modern Web Player**: Video.js player with live controls and status monitoring
- ☁️ **Cloud-Ready**: Docker containerized for easy deployment
- 🛠️ **Auto-Recovery**: Automatic FFmpeg restart on failures
- 📊 **Health Monitoring**: Built-in health checks and status API
- 🔒 **Secure**: CORS-enabled with security headers and private source configuration
- 📈 **Scalable**: Ready for production deployment

## 🏗️ Architecture

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Source URL    │───▶│     FFmpeg       │───▶│   HLS Stream    │
│ (Date-based)    │    │   (Relay +       │    │   (/stream/)    │
│                 │    │   Segmentation)  │    │                 │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Monitoring    │    │   Express.js     │───▶│   Web Player    │
│   & Recovery    │    │   Web Server     │    │   (Video.js)    │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

## 📁 Project Structure

```
/app
├── stream/              # HLS segments (generated by FFmpeg)
├── public/
│   └── index.html      # Web player interface
├── logs/               # Application logs
├── ffmpeg-launcher.sh  # FFmpeg management script
├── server.js           # Express web server
├── start.sh            # Container startup script
├── package.json        # Node.js dependencies
├── Dockerfile          # Container configuration
├── render.yaml         # Render.com deployment
├── fly.toml           # Fly.io deployment
└── .do/app.yaml       # DigitalOcean deployment
```

## 🚀 Quick Start

### Local Development

1. **Clone and setup:**
   ```bash
   cd app
   npm install
   ```

2. **Make scripts executable:**
   ```bash
   chmod +x ffmpeg-launcher.sh start.sh
   ```

3. **Start the stream:**
   ```bash
   ./ffmpeg-launcher.sh start
   npm start
   ```

4. **Access the stream:**
   - Web Player: http://localhost:3000
   - Direct HLS: http://localhost:3000/stream/output.m3u8
   - Health Check: http://localhost:3000/health

### Docker Development

1. **Build and run:**
   ```bash
   docker build -t stream-relay .
   docker run -p 3000:3000 stream-relay
   ```

## ☁️ Cloud Deployment

### 🔥 Fly.io (Recommended)

1. **Install Fly CLI:**
   ```bash
   curl -L https://fly.io/install.sh | sh
   ```

2. **Login and deploy:**
   ```bash
   fly auth login
   fly launch
   fly deploy
   ```

3. **Configure scaling:**
   ```bash
   fly scale count 1
   fly scale vm shared-cpu-1x
   ```

**Pros:** Excellent performance, global edge locations, simple scaling
**Cost:** ~$5-10/month for basic instance

### 🎨 Render.com

1. **Connect your GitHub repository**
2. **Select "Web Service"**
3. **Use these settings:**
   - Environment: Docker
   - Dockerfile path: `./Dockerfile`
   - Port: 3000

**Pros:** Simple deployment, automatic SSL, good free tier
**Cost:** Free tier available, paid plans from $7/month

### 🌊 DigitalOcean App Platform

1. **Create new app from GitHub**
2. **Select your repository**
3. **Configure:**
   - Type: Web Service
   - Run Command: `npm start`
   - Port: 3000

**Pros:** Predictable pricing, good performance
**Cost:** $5-12/month depending on resources

### 🔧 DigitalOcean Droplet (VPS)

1. **Create Ubuntu droplet ($5/month minimum)**
2. **Install Docker:**
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sh get-docker.sh
   ```

3. **Deploy:**
   ```bash
   git clone https://github.com/your-username/stream-relay.git
   cd stream-relay/app
   docker build -t stream-relay .
   docker run -d -p 80:3000 --restart unless-stopped stream-relay
   ```

## 🛠️ Configuration

### Environment Variables

- `PORT`: Server port (default: 3000)
- `NODE_ENV`: Environment (production/development)

### Stream Source Configuration

Edit `ffmpeg-launcher.sh` to modify the source URL pattern:

```bash
BASE_URL="https://forbinaquarium.com/Live/00"
# Constructs: https://forbinaquarium.com/Live/00/phYYMMDD/phYYMMDD_1080p.m3u8
```

### FFmpeg Parameters

Modify HLS settings in `ffmpeg-launcher.sh`:

```bash
ffmpeg -y \
    -i "$source_url" \
    -c copy \                           # Copy streams without re-encoding
    -f hls \                           # Output format: HLS
    -hls_time 6 \                      # Segment duration: 6 seconds
    -hls_list_size 10 \                # Playlist size: 10 segments
    -hls_wrap 20 \                     # Total segments before wrapping
    -hls_delete_threshold 5 \          # Delete segments after 5 newer ones
    -hls_flags delete_segments+append_list \
    "$OUTPUT_DIR/output.m3u8"
```

## 📊 API Endpoints

- `GET /` - Web player interface
- `GET /stream/output.m3u8` - HLS manifest
- `GET /stream/*.ts` - HLS segments
- `GET /health` - Health check
- `GET /api/stream/info` - Stream statistics

## 🔧 Management Commands

### FFmpeg Control

```bash
# Start stream
./ffmpeg-launcher.sh start

# Stop stream
./ffmpeg-launcher.sh stop

# Restart stream
./ffmpeg-launcher.sh restart

# Check status
./ffmpeg-launcher.sh status

# Monitor mode (auto-restart)
./ffmpeg-launcher.sh monitor
```

### Docker Management

```bash
# View logs
docker logs <container-id>

# Restart container
docker restart <container-id>

# Shell access
docker exec -it <container-id> /bin/bash
```

## 🔍 Monitoring & Troubleshooting

### Health Checks

- **Web Interface**: Built-in status panel shows stream health
- **API Health Check**: `GET /health` returns JSON status
- **Container Health**: Docker health check every 30 seconds

### Log Files

- **FFmpeg Logs**: `/app/logs/ffmpeg.log`
- **Application Logs**: Console output (visible in Docker logs)

### Common Issues

1. **Stream Not Starting:**
   - Check source URL is accessible
   - Verify date format in URL construction
   - Check FFmpeg logs for errors

2. **Segments Not Playing:**
   - Verify CORS headers are set
   - Check HLS manifest is accessible
   - Ensure proper MIME types are served

3. **High CPU Usage:**
   - Consider using `-c copy` to avoid re-encoding
   - Adjust HLS segment parameters
   - Monitor with `docker stats`

## 🔐 Security Considerations

- Container runs as non-root user
- CORS configured for streaming requirements
- Security headers via Helmet.js
- No sensitive data in logs
- Health checks don't expose internal details

## 📈 Performance Optimization

### Resource Usage
- **CPU**: Moderate (copy mode reduces encoding load)
- **Memory**: ~200-500MB depending on segment buffer
- **Bandwidth**: Matches source stream bitrate
- **Storage**: Minimal (segments are regularly cleaned)

### Scaling Tips
- Use CDN for global distribution
- Consider multiple instances for redundancy
- Monitor bandwidth usage on cloud providers
- Optimize segment size for your audience

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Test your changes locally
4. Submit a pull request

## 📄 License

MIT License - feel free to use this for commercial or personal projects.

## 🆘 Support

- **Issues**: GitHub Issues for bug reports
- **Discussions**: GitHub Discussions for questions
- **Documentation**: This README and inline comments

---

**Built with ❤️ using FFmpeg, Node.js, and Video.js**
