<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shulmeister's MyTube v2.1</title>
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0f0f0f;
            color: #ffffff;
            line-height: 1.4;
        }

        /* YouTube-style Header */
        .youtube-header {
            background-color: #212121;
            padding: 12px 24px;
            border-bottom: 1px solid #303030;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo {
            font-size: 20px;
            font-weight: 400;
            text-decoration: none;
            color: #ffffff;
        }

        .logo .brand-shulmeister {
            font-size: 14px;
            color: #aaaaaa;
            font-weight: 300;
        }

        .logo .brand-mytube {
            color: #ff0000;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .action-btn:hover {
            background-color: #303030;
        }

        /* Main Content Layout */
        .main-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        /* Video Section */
        .video-section {
            min-width: 0;
        }

        .video-container {
            background-color: #000000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .video-js {
            width: 100%;
            height: auto;
            aspect-ratio: 16/9;
        }

        /* Video Meta Information */
        .video-meta {
            margin-bottom: 16px;
        }

        .video-title {
            font-size: 20px;
            font-weight: 500;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .video-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #aaaaaa;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .live-badge {
            background-color: #cc0000;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .live-badge.offline {
            background-color: #606060;
        }

        /* Video Actions */
        .video-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            border-top: 1px solid #303030;
            border-bottom: 1px solid #303030;
        }

        .action-button {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .action-button:hover {
            background-color: #303030;
        }

        .action-button.primary {
            background-color: #cc0000;
        }

        .action-button.primary:hover {
            background-color: #a60000;
        }

        /* Sidebar */
        .sidebar {
            background-color: #181818;
            border-radius: 12px;
            padding: 16px;
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #303030;
            font-size: 14px;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background-color: #00ff00;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background-color: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stream-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .stream-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .stream-item:hover {
            background-color: #404040;
        }

        .stream-item.active {
            background-color: #ff0000;
        }

        .stream-item.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stream-date {
            font-weight: 500;
        }

        .stream-status {
            font-size: 12px;
            color: #aaaaaa;
        }

        .stream-status.available {
            color: #00ff00;
        }

        .stream-status.unavailable {
            color: #ff4444;
        }

        /* Description Section */
        .description-section {
            background-color: #262626;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .description-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .description-content {
            color: #cccccc;
            font-size: 14px;
            line-height: 1.6;
        }

        .description-content ul {
            padding-left: 20px;
        }

        .description-content li {
            margin-bottom: 4px;
        }

        /* Comments Section */
        .comments-section {
            background-color: #181818;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 8px;
            border-bottom: 1px solid #303030;
        }

        .comments-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 400;
        }

        .sort-options select {
            background-color: transparent;
            border: none;
            color: #aaaaaa;
            font-size: 14px;
            cursor: pointer;
        }

        .sort-options select:focus {
            outline: none;
        }

        .add-comment {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .comment-avatar {
            flex-shrink: 0;
        }

        .comment-avatar i {
            font-size: 32px;
            color: #aaaaaa;
        }

        .comment-input-container {
            flex: 1;
        }

        #comment-input {
            width: 100%;
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #303030;
            color: #ffffff;
            font-size: 14px;
            padding: 8px 0;
            resize: vertical;
            min-height: 20px;
            max-height: 100px;
        }

        #comment-input:focus {
            outline: none;
            border-bottom-color: #ffffff;
        }

        .comment-actions {
            margin-top: 8px;
            display: none;
            gap: 8px;
            justify-content: flex-end;
        }

        .comment-actions.active {
            display: flex;
        }

        .comment-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 18px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #cancel-comment {
            background-color: transparent;
            color: #aaaaaa;
        }

        #cancel-comment:hover {
            background-color: #303030;
        }

        #post-comment {
            background-color: #065fd4;
            color: #ffffff;
        }

        #post-comment:disabled {
            background-color: #303030;
            color: #717171;
            cursor: not-allowed;
        }

        #post-comment:not(:disabled):hover {
            background-color: #4c9eff;
        }

        .comment {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 8px 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .comment-time {
            color: #aaaaaa;
            font-size: 12px;
            margin-left: 8px;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .comment-actions-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comment-action {
            background: none;
            border: none;
            color: #aaaaaa;
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 18px;
            transition: background-color 0.2s;
        }

        .comment-action:hover {
            background-color: #303030;
        }

        .comment-action.liked {
            color: #065fd4;
        }

        .like-button.liked {
            background-color: #263850 !important;
            color: #4fc3f7 !important;
        }

        .like-button.liked i {
            color: #4fc3f7 !important;
        }

        /* Archive Selector Styles */
        .archive-selector {
            background: #1e1e1e;
            border: 1px solid #303030;
            border-radius: 8px;
            margin: 16px 0;
            overflow: hidden;
            max-height: 400px;
        }

        .archive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #2a2a2a;
            border-bottom: 1px solid #303030;
        }

        .archive-header h3 {
            margin: 0;
            font-size: 16px;
            color: #ffffff;
        }

        .close-archive {
            background: none;
            border: none;
            color: #aaaaaa;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-archive:hover {
            color: #ffffff;
        }

        .archive-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .archive-item {
            padding: 12px 16px;
            border-bottom: 1px solid #303030;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .archive-item:hover {
            background-color: #2a2a2a;
        }

        .archive-item:last-child {
            border-bottom: none;
        }

        .archive-item.current {
            background-color: #263850;
            border-left: 4px solid #4fc3f7;
        }

        .archive-date {
            font-weight: 500;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .archive-venue {
            color: #aaaaaa;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .archive-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #606060;
        }

        .loading {
            padding: 16px;
            text-align: center;
            color: #aaaaaa;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            
            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .youtube-header {
                padding: 8px 16px;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .video-actions {
                flex-wrap: wrap;
            }
            
            .action-button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- YouTube-style Header -->
    <header class="youtube-header">
        <div class="logo-container">
            <a href="#" class="logo">
                <span class="brand-shulmeister">Shulmeister's</span> 
                <span class="brand-mytube">MyTube</span>
            </a>
        </div>
        <div class="header-actions">
            <button class="action-btn" onclick="refreshStream()" title="Refresh Stream">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="action-btn" onclick="checkHealth()" title="Health Check">
                <i class="fas fa-heart"></i>
            </button>
            <button class="action-btn" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Video Section -->
        <div class="video-section">
            <div class="video-container">
                <video
                    id="live-player"
                    class="video-js vjs-default-skin"
                    controls
                    preload="auto"
                    autoplay
                    muted
                    playsinline
                    data-setup='{"fluid": true, "responsive": true}'>
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a web browser that
                        <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                    </p>
                </video>
            </div>

            <!-- Video Meta -->
            <div class="video-meta">
                <h1 class="video-title">Live Stream Relay</h1>
                <div class="video-stats">
                    <span class="live-badge" id="live-badge">LIVE</span>
                    <span id="viewer-count">‚Ä¢</span>
                    <span id="stream-date"></span>
                </div>
            </div>

            <!-- Video Actions -->
                        <!-- Video Actions -->
            <div class="video-actions">
                <button class="action-button primary" id="like-button" onclick="toggleLike()">
                    <i class="fas fa-thumbs-up"></i>
                    <span id="like-text">Like</span>
                    <span id="like-count">(42)</span>
                </button>
                <button class="action-button" id="archive-button" onclick="toggleArchiveSelector()">
                    <i class="fas fa-archive"></i>
                    <span id="archive-text">Archive</span>
                </button>
                <button class="action-button" id="live-button" onclick="backToLive()" style="display: none;">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Back to Live</span>
                </button>
                <button class="action-button">
                    <i class="fas fa-share"></i>
                    Share
                </button>
                <button class="action-button" onclick="refreshStream()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="action-button" onclick="restartFFmpeg()">
                    <i class="fas fa-power-off"></i>
                    Restart Stream
                </button>
                <button class="action-button" onclick="checkHealth()">
                    <i class="fas fa-heart-pulse"></i>
                    Health Check
                </button>
            </div>

            <!-- Archive Selector (Hidden by default) -->
            <div id="archive-selector" class="archive-selector" style="display: none;">
                <div class="archive-header">
                    <h3>üóÑÔ∏è Archived Shows</h3>
                    <button class="close-archive" onclick="toggleArchiveSelector()">√ó</button>
                </div>
                <div id="archive-list" class="archive-list">
                    <div class="loading">Loading archive...</div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
                <div class="comments-header">
                    <h3><span id="comment-count">12</span> Comments</h3>
                    <div class="sort-options">
                        <select id="comment-sort">
                            <option value="top">Top comments</option>
                            <option value="newest">Newest first</option>
                        </select>
                    </div>
                </div>

                <!-- Add Comment -->
                <div class="add-comment">
                    <div class="comment-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="comment-input-container">
                        <textarea id="comment-input" placeholder="Add a comment..."></textarea>
                        <div class="comment-actions">
                            <button id="cancel-comment" onclick="cancelComment()">Cancel</button>
                            <button id="post-comment" onclick="postComment()" disabled>Comment</button>
                        </div>
                    </div>
                </div>

                <!-- Comments List -->
                <div class="comments-list" id="comments-list">
                    <!-- Comments will be populated here -->
                </div>
            </div>

            <!-- Description -->
            <div class="description-section">
                <div class="description-title">About This Stream</div>
                <div class="description-content">
                    <p>This is a self-hosted HLS relay that automatically pulls the daily stream from the source and serves it via this web interface. The stream URL is automatically constructed based on the current UTC date.</p>
                    
                    <h4>Technical Details:</h4>
                    <ul>
                        <li>üîß <strong>Backend:</strong> Node.js with Express</li>
                        <li>üé• <strong>Streaming:</strong> FFmpeg with HLS segmentation</li>
                        <li>üì± <strong>Player:</strong> Video.js with HLS support</li>
                        <li>‚òÅÔ∏è <strong>Deployment:</strong> Docker container ready</li>
                        <li>üîÑ <strong>Auto-restart:</strong> FFmpeg monitoring and recovery</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Stream Info -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-calendar-alt"></i>
                    Current Stream
                </div>
                <div class="stream-list" id="stream-list">
                    <!-- Current stream info will be populated by JavaScript -->
                </div>
            </div>

            <!-- Stream Status -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Stream Status
                </div>
                <div class="status-item">
                    <span><span class="status-indicator" id="stream-indicator"></span>Connection</span>
                    <span id="stream-status">Checking...</span>
                </div>
                <div class="status-item">
                    <span>Last Updated</span>
                    <span id="last-updated">-</span>
                </div>
                <div class="status-item">
                    <span>Segments</span>
                    <span id="segment-count">-</span>
                </div>
            </div>

            <!-- Stream Info -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-info-circle"></i>
                    Stream Info
                </div>
                <div class="status-item">
                    <span>Source Date</span>
                    <span id="stream-source">-</span>
                </div>
                <div class="status-item">
                    <span>Format</span>
                    <span>HLS (m3u8)</span>
                </div>
                <div class="status-item">
                    <span>Quality</span>
                    <span>1080p</span>
                </div>
            </div>

            <!-- Time Info -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-clock"></i>
                    Current Time
                </div>
                <div class="status-item">
                    <span>Local</span>
                    <span id="current-time">-</span>
                </div>
                <div class="status-item">
                    <span>UTC</span>
                    <span id="utc-time">-</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    <script>
        let player;
        let statusCheckInterval;
        let availableShows = [];

        // --- Constants ---
        const API_BASE_URL = ''; // Use relative paths

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MyTube v2.1 - Initializing...');
            
            player = videojs('live-player', {
                html5: { hls: { overrideNative: true } },
                liveui: true,
                fluid: true,
                responsive: true,
                autoplay: true,
                muted: true
            });

            player.ready(async () => {
                console.log('Player ready.');
                await initializePage();
                
                statusCheckInterval = setInterval(checkHealth, 15000);
                setInterval(updateTime, 1000);
            });

            player.on('error', function() {
                console.error('Player error:', player.error());
                const statusEl = document.getElementById('stream-status');
                statusEl.textContent = 'Playback Error';
                // Consider a more robust retry mechanism if needed
            });
        });

        async function initializePage() {
            try {
                await loadCurrentStream();
                checkHealth();
                updateTime();
            } catch (error) {
                console.error("Initialization failed:", error);
                const statusEl = document.getElementById('stream-status');
                statusEl.textContent = 'Init Failed';
            }
        }

        // --- Auto Stream Detection ---
        async function loadCurrentStream() {
            try {
                console.log("Detecting current stream...");
                const response = await fetch(`${API_BASE_URL}/api/stream/current`);
                const streamData = await response.json();
                
                if (streamData.available) {
                    // Update UI
                    document.getElementById('stream-date').textContent = streamData.date;
                    document.getElementById('stream-source').textContent = streamData.dateStr;
                    
                    // Update stream list
                    const streamList = document.getElementById('stream-list');
                    streamList.innerHTML = `
                        <div class="stream-item active">
                            <div class="stream-date">${streamData.date}</div>
                            <div class="stream-venue">Current Live Stream</div>
                        </div>
                    `;
                    
                    // Load stream
                    console.log(`Loading current stream: ${streamData.streamUrl}`);
                    
                    // Capture current stream info for archive functionality
                    currentStreamUrl = streamData.streamUrl;
                    currentVideoTitle = `Phish - ${streamData.date} - Live Stream`;
                    
                    player.src({
                        src: streamData.streamUrl,
                        type: 'application/x-mpegURL'
                    });
                    player.load();
                    player.play().catch(e => console.log("Autoplay was prevented.", e));
                    
                } else {
                    // No stream available
                    document.getElementById('stream-date').textContent = 'No Stream';
                    document.getElementById('stream-source').textContent = 'N/A';
                    
                    const streamList = document.getElementById('stream-list');
                    streamList.innerHTML = `
                        <div class="stream-item">
                            <div class="stream-date">No Live Stream</div>
                            <div class="stream-venue">Check back during show times</div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error("Failed to load current stream:", error);
                document.getElementById('stream-date').textContent = 'Error';
                document.getElementById('stream-source').textContent = 'Failed to load';
            }
        }

        async function checkHealth() {
            const indicator = document.getElementById('stream-indicator');
            const statusEl = document.getElementById('stream-status');
            const liveBadge = document.getElementById('live-badge');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (!response.ok) throw new Error('Health check response not OK');
                const data = await response.json();

                indicator.className = 'status-indicator online';
                statusEl.textContent = 'Online';
                liveBadge.textContent = 'ONLINE';
                liveBadge.className = 'live-badge';
                document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleTimeString();

            } catch (error) {
                console.error('Health check failed:', error);
                indicator.className = 'status-indicator offline';
                statusEl.textContent = 'Error';
                liveBadge.textContent = 'ERROR';
                liveBadge.className = 'live-badge offline';
            }
        }

        async function restartFFmpeg() {
            // This function is deprecated as FFmpeg is no longer used.
            // It can be removed or repurposed if needed.
            console.warn("Restart FFmpeg is deprecated.");
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
            document.getElementById('utc-time').textContent = now.toISOString().slice(11, 19);
        }

        // --- Player & Stream Control ---
        function refreshStream() {
            loadCurrentStream();
        }

        function toggleFullscreen() {
            if (player.isFullscreen()) {
                player.exitFullscreen();
            } else {
                player.requestFullscreen();
            }
        }

        // --- Like Button Functionality ---
        let isLiked = false;
        let likeCount = 42; // Starting count

        function toggleLike() {
            const likeButton = document.getElementById('like-button');
            const likeText = document.getElementById('like-text');
            const likeCountEl = document.getElementById('like-count');
            
            isLiked = !isLiked;
            
            if (isLiked) {
                likeButton.classList.add('liked');
                likeText.textContent = 'Liked';
                likeCount++;
                
                // Add a nice animation
                likeButton.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    likeButton.style.transform = 'scale(1)';
                }, 150);
            } else {
                likeButton.classList.remove('liked');
                likeText.textContent = 'Like';
                likeCount--;
            }
            
            likeCountEl.textContent = `(${likeCount})`;
            
            // Save to localStorage
            localStorage.setItem('myTube_liked', isLiked);
            localStorage.setItem('myTube_likeCount', likeCount);
        }

        // Archive functions
        let archiveShows = [];
        let currentArchiveShow = null;
        let currentStreamUrl = '';
        let currentVideoTitle = 'Phish Live Stream';

        function toggleArchiveSelector() {
            const selector = document.getElementById('archive-selector');
            const button = document.getElementById('archive-button');
            
            if (selector.style.display === 'none') {
                selector.style.display = 'block';
                button.style.backgroundColor = '#263850';
                loadArchiveShows();
            } else {
                selector.style.display = 'none';
                button.style.backgroundColor = '';
            }
        }

        async function loadArchiveShows() {
            const archiveList = document.getElementById('archive-list');
            archiveList.innerHTML = '<div class="loading">Loading archive...</div>';
            
            try {
                const response = await fetch('/api/archive/shows');
                const data = await response.json();
                archiveShows = data.shows;
                
                if (archiveShows.length === 0) {
                    archiveList.innerHTML = '<div class="loading">No archived shows yet</div>';
                    return;
                }
                
                archiveList.innerHTML = archiveShows.map(show => `
                    <div class="archive-item ${currentArchiveShow === show.id ? 'current' : ''}" 
                         onclick="playArchivedShow('${show.id}')">
                        <div class="archive-date">${formatDate(show.date)}</div>
                        <div class="archive-venue">${show.venue}</div>
                        <div class="archive-meta">
                            <span>${show.fileSize}</span>
                            <span>${show.source === 'imported' ? 'üìÅ Imported' : 'üîÑ Downloaded'}</span>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading archive:', error);
                archiveList.innerHTML = '<div class="loading">Error loading archive</div>';
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function playArchivedShow(showId) {
            currentArchiveShow = showId;
            const show = archiveShows.find(s => s.id === showId);
            
            if (show) {
                // Update video title
                document.getElementById('video-title').textContent = 
                    `Phish - ${formatDate(show.date)} - ${show.venue}`;
                
                // Update video source to archived file
                const videoElement = document.getElementById('video-player');
                videoElement.src = `/api/archive/stream/${showId}`;
                videoElement.load();
                
                // Update archive selector to show current
                loadArchiveShows();
                
                // Close archive selector
                toggleArchiveSelector();
                
                // Update live badge
                document.querySelector('.live-badge').textContent = 'ARCHIVED';
                document.querySelector('.live-badge').classList.add('offline');
                
                // Show "Back to Live" button
                document.getElementById('live-button').style.display = 'block';
            }
        }

        function backToLive() {
            currentArchiveShow = null;
            
            // Reset to live stream
            document.getElementById('video-title').textContent = currentVideoTitle;
            
            const videoElement = document.getElementById('video-player');
            videoElement.src = currentStreamUrl;
            videoElement.load();
            
            // Update live badge
            document.querySelector('.live-badge').textContent = 'LIVE';
            document.querySelector('.live-badge').classList.remove('offline');
            
            // Hide "Back to Live" button
            document.getElementById('live-button').style.display = 'none';
        }

        // --- Comments Functionality ---
        let comments = [
            {
                id: 1,
                author: "PhishHead_92",
                time: "2 hours ago",
                text: "This is amazing! Thanks for hosting this stream. The quality is incredible! üéµ",
                likes: 15,
                liked: false
            },
            {
                id: 2,
                author: "JamFan2025",
                time: "1 hour ago", 
                text: "Finally caught a show! Been waiting all tour for this. The sound is crystal clear.",
                likes: 8,
                liked: false
            },
            {
                id: 3,
                author: "TourRat_Official",
                time: "45 minutes ago",
                text: "Couch tour life! This is so much better than the official streams. Thank you! üôè",
                likes: 23,
                liked: false
            },
            {
                id: 4,
                author: "GrooveSeeker",
                time: "30 minutes ago",
                text: "That last jam was INSANE! Anyone else catch that transition?!",
                likes: 12,
                liked: false
            },
            {
                id: 5,
                author: "VintagePhish",
                time: "15 minutes ago",
                text: "Been following since '95 and this stream quality rivals being there. Incredible work!",
                likes: 31,
                liked: false
            }
        ];

        function initializeComments() {
            renderComments();
            updateCommentCount();
            
            // Load saved like state
            const savedLiked = localStorage.getItem('myTube_liked') === 'true';
            const savedCount = parseInt(localStorage.getItem('myTube_likeCount')) || 42;
            
            if (savedLiked) {
                isLiked = true;
                likeCount = savedCount;
                document.getElementById('like-button').classList.add('liked');
                document.getElementById('like-text').textContent = 'Liked';
                document.getElementById('like-count').textContent = `(${likeCount})`;
            }
        }

        function renderComments() {
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                const commentEl = document.createElement('div');
                commentEl.className = 'comment';
                commentEl.innerHTML = `
                    <div class="comment-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="comment-content">
                        <div class="comment-author">
                            ${comment.author}
                            <span class="comment-time">${comment.time}</span>
                        </div>
                        <div class="comment-text">${comment.text}</div>
                        <div class="comment-actions-bar">
                            <button class="comment-action ${comment.liked ? 'liked' : ''}" onclick="toggleCommentLike(${comment.id})">
                                <i class="fas fa-thumbs-up"></i> ${comment.likes}
                            </button>
                            <button class="comment-action">
                                <i class="fas fa-thumbs-down"></i>
                            </button>
                            <button class="comment-action">Reply</button>
                        </div>
                    </div>
                `;
                commentsList.appendChild(commentEl);
            });
        }

        function updateCommentCount() {
            document.getElementById('comment-count').textContent = comments.length;
        }

        function toggleCommentLike(commentId) {
            const comment = comments.find(c => c.id === commentId);
            if (comment) {
                comment.liked = !comment.liked;
                comment.likes += comment.liked ? 1 : -1;
                renderComments();
            }
        }

        function postComment() {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            
            if (text) {
                const newComment = {
                    id: Date.now(),
                    author: "You",
                    time: "Just now",
                    text: text,
                    likes: 0,
                    liked: false
                };
                
                comments.unshift(newComment); // Add to beginning
                input.value = '';
                toggleCommentActions(false);
                renderComments();
                updateCommentCount();
            }
        }

        function cancelComment() {
            document.getElementById('comment-input').value = '';
            toggleCommentActions(false);
        }

        function toggleCommentActions(show) {
            const actions = document.querySelector('.comment-actions');
            const postButton = document.getElementById('post-comment');
            
            if (show) {
                actions.classList.add('active');
            } else {
                actions.classList.remove('active');
            }
        }

        // Comment input event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const commentInput = document.getElementById('comment-input');
            const postButton = document.getElementById('post-comment');
            
            commentInput.addEventListener('focus', () => toggleCommentActions(true));
            commentInput.addEventListener('input', function() {
                const hasText = this.value.trim().length > 0;
                postButton.disabled = !hasText;
            });
            
            commentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!postButton.disabled) {
                        postComment();
                    }
                }
            });
            
            // Initialize comments after DOM is ready
            setTimeout(initializeComments, 100);
        });

        // --- Cleanup ---
        window.addEventListener('beforeunload', function() {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            if (player) player.dispose();
        });
    </script>
</body>
</html>
