<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shulmeister's MyTube v2.1</title>
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0f0f0f;
            color: #ffffff;
            line-height: 1.4;
        }

        /* YouTube-style Header */
        .youtube-header {
            background-color: #212121;
            padding: 12px 24px;
            border-bottom: 1px solid #303030;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo {
            font-size: 20px;
            font-weight: 400;
            text-decoration: none;
            color: #ffffff;
        }

        .logo .brand-shulmeister {
            font-size: 14px;
            color: #aaaaaa;
            font-weight: 300;
        }

        .logo .brand-mytube {
            color: #ff0000;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .action-btn:hover {
            background-color: #303030;
        }

        /* Main Content Layout */
        .main-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 24px;
        }

        /* Video Section */
        .video-section {
            min-width: 0;
        }

        .video-container {
            background-color: #000000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .video-js {
            width: 100%;
            height: auto;
            aspect-ratio: 16/9;
        }

        /* Video Meta Information */
        .video-meta {
            margin-bottom: 16px;
        }

        .video-title {
            font-size: 20px;
            font-weight: 500;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .video-stats {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #aaaaaa;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .live-badge {
            background-color: #cc0000;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .live-badge.offline {
            background-color: #606060;
        }

        /* Video Actions */
        .video-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 0;
            border-top: 1px solid #303030;
            border-bottom: 1px solid #303030;
        }

        .action-button {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .action-button:hover {
            background-color: #303030;
        }

        .action-button.primary {
            background-color: #cc0000;
        }

        .action-button.primary:hover {
            background-color: #a60000;
        }

        /* Sidebar */
        .sidebar {
            background-color: #181818;
            border-radius: 12px;
            padding: 16px;
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #303030;
            font-size: 14px;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background-color: #00ff00;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background-color: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Stream Selector */
        .stream-selector {
            background-color: #262626;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .stream-selector select {
            width: 100%;
            background-color: #404040;
            border: 1px solid #606060;
            border-radius: 6px;
            color: #ffffff;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
        }

        .stream-selector select:focus {
            outline: none;
            border-color: #ff0000;
        }

        .stream-selector select option {
            background-color: #404040;
            color: #ffffff;
        }

        .stream-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .stream-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .stream-item:hover {
            background-color: #404040;
        }

        .stream-item.active {
            background-color: #ff0000;
        }

        .stream-item.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stream-date {
            font-weight: 500;
        }

        .stream-status {
            font-size: 12px;
            color: #aaaaaa;
        }

        .stream-status.available {
            color: #00ff00;
        }

        .stream-status.unavailable {
            color: #ff4444;
        }

        /* Description Section */
        .description-section {
            background-color: #262626;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .description-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .description-content {
            color: #cccccc;
            font-size: 14px;
            line-height: 1.6;
        }

        .description-content ul {
            padding-left: 20px;
        }

        .description-content li {
            margin-bottom: 4px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            
            .sidebar {
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .youtube-header {
                padding: 8px 16px;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .video-actions {
                flex-wrap: wrap;
            }
            
            .action-button {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- YouTube-style Header -->
    <header class="youtube-header">
        <div class="logo-container">
            <a href="#" class="logo">
                <span class="brand-shulmeister">Shulmeister's</span> 
                <span class="brand-mytube">MyTube</span>
            </a>
        </div>
        <div class="header-actions">
            <button class="action-btn" onclick="refreshStream()" title="Refresh Stream">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="action-btn" onclick="checkHealth()" title="Health Check">
                <i class="fas fa-heart"></i>
            </button>
            <button class="action-btn" onclick="toggleFullscreen()" title="Fullscreen">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Video Section -->
        <div class="video-section">
            <div class="video-container">
                <video
                    id="live-player"
                    class="video-js vjs-default-skin"
                    controls
                    preload="auto"
                    autoplay
                    muted
                    playsinline
                    data-setup='{"fluid": true, "responsive": true}'>
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a web browser that
                        <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                    </p>
                </video>
            </div>

            <!-- Video Meta -->
            <div class="video-meta">
                <h1 class="video-title">Live Stream Relay</h1>
                <div class="video-stats">
                    <span class="live-badge" id="live-badge">LIVE</span>
                    <span id="viewer-count">•</span>
                    <span id="stream-date"></span>
                </div>
            </div>

            <!-- Video Actions -->
            <div class="video-actions">
                <button class="action-button primary">
                    <i class="fas fa-thumbs-up"></i>
                    Like
                </button>
                <button class="action-button">
                    <i class="fas fa-share"></i>
                    Share
                </button>
                <button class="action-button" onclick="refreshStream()">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="action-button" onclick="restartFFmpeg()">
                    <i class="fas fa-power-off"></i>
                    Restart Stream
                </button>
                <button class="action-button" onclick="checkHealth()">
                    <i class="fas fa-heart"></i>
                    Status
                </button>
            </div>

            <!-- Description -->
            <div class="description-section">
                <div class="description-title">About This Stream</div>
                <div class="description-content">
                    <p>This is a self-hosted HLS relay that automatically pulls the daily stream from the source and serves it via this web interface. The stream URL is automatically constructed based on the current UTC date.</p>
                    
                    <h4>Technical Details:</h4>
                    <ul>
                        <li>🔧 <strong>Backend:</strong> Node.js with Express</li>
                        <li>🎥 <strong>Streaming:</strong> FFmpeg with HLS segmentation</li>
                        <li>📱 <strong>Player:</strong> Video.js with HLS support</li>
                        <li>☁️ <strong>Deployment:</strong> Docker container ready</li>
                        <li>🔄 <strong>Auto-restart:</strong> FFmpeg monitoring and recovery</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Stream Selector -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-calendar-alt"></i>
                    Select Stream Date
                </div>
                <div class="stream-selector">
                    <select id="stream-date-selector" onchange="changeStreamDate()">
                        <option value="auto">Auto (Latest Available)</option>
                    </select>
                </div>
                <div class="stream-list" id="stream-list">
                    <!-- Stream items will be populated by JavaScript -->
                </div>
            </div>

            <!-- Stream Status -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-broadcast-tower"></i>
                    Stream Status
                </div>
                <div class="status-item">
                    <span><span class="status-indicator" id="stream-indicator"></span>Connection</span>
                    <span id="stream-status">Checking...</span>
                </div>
                <div class="status-item">
                    <span>Last Updated</span>
                    <span id="last-updated">-</span>
                </div>
                <div class="status-item">
                    <span>Segments</span>
                    <span id="segment-count">-</span>
                </div>
            </div>

            <!-- Stream Info -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-info-circle"></i>
                    Stream Info
                </div>
                <div class="status-item">
                    <span>Source Date</span>
                    <span id="stream-source">-</span>
                </div>
                <div class="status-item">
                    <span>Format</span>
                    <span>HLS (m3u8)</span>
                </div>
                <div class="status-item">
                    <span>Quality</span>
                    <span>1080p</span>
                </div>
            </div>

            <!-- Time Info -->
            <div class="sidebar-section">
                <div class="sidebar-title">
                    <i class="fas fa-clock"></i>
                    Current Time
                </div>
                <div class="status-item">
                    <span>Local</span>
                    <span id="current-time">-</span>
                </div>
                <div class="status-item">
                    <span>UTC</span>
                    <span id="utc-time">-</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    <script>
        let player;
        let statusCheckInterval;
        let availableShows = [];

        // --- Constants ---
        const API_BASE_URL = ''; // Use relative paths

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MyTube v2.1 - Initializing...');
            
            player = videojs('live-player', {
                html5: { hls: { overrideNative: true } },
                liveui: true,
                fluid: true,
                responsive: true,
                autoplay: true,
                muted: true
            });

            player.ready(async () => {
                console.log('Player ready.');
                await initializePage();
                
                statusCheckInterval = setInterval(checkHealth, 15000);
                setInterval(updateTime, 1000);
            });

            player.on('error', function() {
                console.error('Player error:', player.error());
                const statusEl = document.getElementById('stream-status');
                statusEl.textContent = 'Playback Error';
                // Consider a more robust retry mechanism if needed
            });
        });

        async function initializePage() {
            try {
                await fetchShows();
                populateStreamSelector();
                checkHealth();
                updateTime();
            } catch (error) {
                console.error("Initialization failed:", error);
                const statusEl = document.getElementById('stream-status');
                statusEl.textContent = 'Init Failed';
            }
        }

        // --- Data Fetching & API Calls ---
        async function fetchShows() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/shows`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                availableShows = await response.json();
                console.log('Fetched shows:', availableShows);
            } catch (error) {
                console.error('Failed to fetch shows:', error);
                availableShows = []; // Ensure it's an empty array on failure
            }
        }

        async function checkHealth() {
            const indicator = document.getElementById('stream-indicator');
            const statusEl = document.getElementById('stream-status');
            const liveBadge = document.getElementById('live-badge');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (!response.ok) throw new Error('Health check response not OK');
                const data = await response.json();

                indicator.className = 'status-indicator online';
                statusEl.textContent = 'Online';
                liveBadge.textContent = 'ONLINE';
                liveBadge.className = 'live-badge';
                document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleTimeString();

            } catch (error) {
                console.error('Health check failed:', error);
                indicator.className = 'status-indicator offline';
                statusEl.textContent = 'Error';
                liveBadge.textContent = 'ERROR';
                liveBadge.className = 'live-badge offline';
            }
        }

        async function restartFFmpeg() {
            // This function is deprecated as FFmpeg is no longer used.
            // It can be removed or repurposed if needed.
            console.warn("Restart FFmpeg is deprecated.");
        }

        // --- UI Population and Updates ---
        function populateStreamSelector() {
            console.log('Populating stream selector with shows:', availableShows);
            const selector = document.getElementById('stream-date-selector');
            const streamList = document.getElementById('stream-list');

            selector.innerHTML = ''; // Clear existing options
            streamList.innerHTML = ''; // Clear list

            if (availableShows.length === 0) {
                selector.innerHTML = '<option>No shows available</option>';
                return;
            }

            availableShows.forEach(show => {
                const option = document.createElement('option');
                option.value = show.id;
                option.textContent = `${show.date} - ${show.venue}`;
                selector.appendChild(option);

                const item = document.createElement('div');
                item.className = 'stream-item';
                item.dataset.id = show.id;
                item.innerHTML = `
                    <div class="stream-date">${show.date} - ${show.venue}</div>
                    <div class="stream-status" id="status-${show.id}"></div>
                `;
                item.onclick = () => selectStream(show.id);
                streamList.appendChild(item);
            });

            // Auto-select the first show
            const firstShowId = availableShows[0].id;
            selector.value = firstShowId;
            selectStream(firstShowId);
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString();
            document.getElementById('utc-time').textContent = now.toISOString().slice(11, 19);
        }

        // --- Player & Stream Control ---
        function changeStreamDate() {
            const selector = document.getElementById('stream-date-selector');
            selectStream(selector.value);
        }

        function selectStream(showId) {
            if (!showId) {
                console.error("Invalid show ID provided to selectStream.");
                return;
            }
            
            console.log(`Attempting to select stream for show ID: ${showId}`);
            
            // Update UI
            document.querySelectorAll('.stream-item').forEach(item => {
                item.classList.toggle('active', item.dataset.id === showId);
            });
            document.getElementById('stream-date-selector').value = showId;

            const selectedShow = availableShows.find(s => s.id === showId);
            if (selectedShow) {
                document.getElementById('stream-date').textContent = selectedShow.date;
                document.getElementById('stream-source').textContent = selectedShow.id;
            }

            // Construct stream URL and load into player
            const streamUrl = `${API_BASE_URL}/api/stream/load-date/${showId}`;
            console.log(`Loading stream URL: ${streamUrl}`);
            
            player.src({
                src: streamUrl,
                type: 'application/x-mpegURL'
            });
            player.load();
            player.play().catch(e => console.log("Autoplay was prevented.", e));
        }
        
        function refreshStream() {
            const currentShowId = document.getElementById('stream-date-selector').value;
            selectStream(currentShowId);
        }

        function toggleFullscreen() {
            if (player.isFullscreen()) {
                player.exitFullscreen();
            } else {
                player.requestFullscreen();
            }
        }

        // --- Cleanup ---
        window.addEventListener('beforeunload', function() {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            if (player) player.dispose();
        });
    </script>
</body>
</html>
