<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream Relay</title>
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .video-container {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .video-js {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .status-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background: #f87171;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .info-section {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 50px;
            opacity: 0.7;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .video-container {
                padding: 15px;
            }
            
            .status-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåä Live Stream Relay</h1>
            <p>Self-hosted HLS stream with automatic daily updates</p>
        </div>

        <div class="video-container">
            <video-js
                id="live-player"
                class="video-js vjs-default-skin"
                controls
                preload="auto"
                data-setup='{"fluid": true, "responsive": true}'
                poster="">
                <p class="vjs-no-js">
                    To view this video please enable JavaScript, and consider upgrading to a web browser that
                    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                </p>
            </video-js>
        </div>

        <div class="status-panel">
            <div class="status-card">
                <h3><span class="status-indicator" id="stream-indicator"></span>Stream Status</h3>
                <div id="stream-status">Checking...</div>
                <div id="last-updated"></div>
            </div>
            
            <div class="status-card">
                <h3>üìä Stream Info</h3>
                <div id="stream-info">
                    <div>Segments: <span id="segment-count">-</span></div>
                    <div>Source: <span id="stream-source">-</span></div>
                </div>
            </div>
            
            <div class="status-card">
                <h3>üïí Current Time</h3>
                <div id="current-time"></div>
                <div id="utc-time"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshStream()">üîÑ Refresh Stream</button>
            <button class="btn" onclick="checkHealth()">‚ù§Ô∏è Health Check</button>
            <button class="btn" onclick="toggleFullscreen()">üì∫ Fullscreen</button>
        </div>

        <div class="info-section">
            <h3>About This Stream</h3>
            <p>This is a self-hosted HLS relay that automatically pulls the daily stream from the source and serves it via this web interface. The stream URL is automatically constructed based on the current UTC date.</p>
            
            <h4>Technical Details:</h4>
            <ul>
                <li>üîß <strong>Backend:</strong> Node.js with Express</li>
                <li>üé• <strong>Streaming:</strong> FFmpeg with HLS segmentation</li>
                <li>üì± <strong>Player:</strong> Video.js with HLS support</li>
                <li>‚òÅÔ∏è <strong>Deployment:</strong> Docker container ready</li>
                <li>üîÑ <strong>Auto-restart:</strong> FFmpeg monitoring and recovery</li>
            </ul>
        </div>

        <div class="footer">
            <p>Powered by FFmpeg + Node.js | Stream Relay v1.0</p>
        </div>
    </div>

    <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
    <script>
        let player;
        let statusCheckInterval;

        // Initialize Video.js player
        document.addEventListener('DOMContentLoaded', function() {
            player = videojs('live-player', {
                sources: [{
                    src: '/stream/output.m3u8',
                    type: 'application/x-mpegURL'
                }],
                html5: {
                    hls: {
                        overrideNative: true
                    }
                },
                liveui: true,
                fluid: true,
                responsive: true
            });

            // Start status checking
            checkHealth();
            updateTime();
            
            statusCheckInterval = setInterval(checkHealth, 10000); // Check every 10 seconds
            setInterval(updateTime, 1000); // Update time every second
        });

        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                const indicator = document.getElementById('stream-indicator');
                const status = document.getElementById('stream-status');
                const lastUpdated = document.getElementById('last-updated');
                
                if (data.status === 'ok' && data.stream.available) {
                    indicator.className = 'status-indicator online';
                    status.textContent = data.stream.isRecent ? 'Live' : 'Stream Available (Not Recent)';
                    lastUpdated.textContent = `Updated: ${new Date(data.stream.lastUpdated).toLocaleString()}`;
                } else {
                    indicator.className = 'status-indicator offline';
                    status.textContent = 'Stream Unavailable';
                    lastUpdated.textContent = 'No recent updates';
                }
                
                // Get additional stream info
                getStreamInfo();
            } catch (error) {
                console.error('Health check failed:', error);
                const indicator = document.getElementById('stream-indicator');
                const status = document.getElementById('stream-status');
                
                indicator.className = 'status-indicator offline';
                status.textContent = 'Connection Error';
            }
        }

        async function getStreamInfo() {
            try {
                const response = await fetch('/api/stream/info');
                const data = await response.json();
                
                document.getElementById('segment-count').textContent = data.segmentCount || 0;
                
                // Generate current expected source URL
                const now = new Date();
                const year = String(now.getUTCFullYear()).slice(-2);
                const month = String(now.getUTCMonth() + 1).padStart(2, '0');
                const day = String(now.getUTCDate()).padStart(2, '0');
                const dateStr = year + month + day;
                const sourceUrl = `https://forbinaquarium.com/Live/00/ph${dateStr}/ph${dateStr}_1080p.m3u8`;
                
                document.getElementById('stream-source').innerHTML = 
                    `<a href="${sourceUrl}" target="_blank" style="color: #60a5fa;">${dateStr}</a>`;
                
            } catch (error) {
                console.error('Failed to get stream info:', error);
            }
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                `Local: ${now.toLocaleString()}`;
            document.getElementById('utc-time').textContent = 
                `UTC: ${now.toISOString().slice(0, 19).replace('T', ' ')}`;
        }

        function refreshStream() {
            if (player) {
                player.src('/stream/output.m3u8');
                player.load();
                checkHealth();
            }
        }

        function toggleFullscreen() {
            if (player) {
                if (player.isFullscreen()) {
                    player.exitFullscreen();
                } else {
                    player.requestFullscreen();
                }
            }
        }

        // Handle player errors
        if (player) {
            player.on('error', function() {
                console.error('Player error:', player.error());
                setTimeout(refreshStream, 5000); // Auto-retry after 5 seconds
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            if (player) {
                player.dispose();
            }
        });
    </script>
</body>
</html>
